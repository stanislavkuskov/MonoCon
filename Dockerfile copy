FROM developer-nn:latest


# Install miniconda
ENV PATH="/root/miniconda3/bin:${PATH}"
ARG PATH="/root/miniconda3/bin:${PATH}"
# RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && \
#     # rm -rf /root/*conda* && \
#     # rm -rf /root/.conda && \
#     mkdir /root/.conda && \
#     bash Miniconda3-latest-Linux-x86_64.sh -b && \
#     rm -f Miniconda3-latest-Linux-x86_64.sh && \
#     conda --version

# Install miniconda
ENV CONDA_DIR /opt/conda

RUN set -ex \
    && apt-get update -yqq \
    && apt-get upgrade -yqq \
    && apt-get install -yqq --no-install-recommends \
    && wget --no-check-certificate https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh \
    && /bin/bash Miniconda3-latest-Linux-x86_64.sh -f -b -p /opt/miniconda \
    && /opt/miniconda/bin/conda install conda \
    && /opt/miniconda/bin/conda clean -yq -a \
    && rm Miniconda3-latest-Linux-x86_64.sh \
    && rm -rf \
        /tmp/* \
        /var/tmp/* \
        /usr/share/man \
        /usr/share/doc \
        /usr/share/doc-base

# Put conda in path so we can use conda activate
ENV PATH=$CONDA_DIR/bin:$PATH

RUN conda create -n monocon python=3.6
RUN . /root/.bashrc && conda activate monocon && \
        conda install \
        pytorch==1.5.1 \
        torchvision==0.6.1 \
        cudatoolkit=10.1 -c pytorch

RUN . /root/.bashrc && conda activate monocon && \
        pip install mmcv-full==1.3.1 -f https://download.openmmlab.com/mmcv/dist/cu101/torch1.5.0/index.html && \
        pip install cython numpy

# COPY mmdetection-2.11.0 /tmp/
# WORKDIR /tmp/mmdetection-2.11.0/
RUN . /root/.bashrc && conda activate monocon && \
        pip install mmsegmentation==0.13.0 && \
        pip install timm && \
        pip uninstall -y pycocotools && \
        pip uninstall -y mmpycocotools && \
        pip install mmpycocotools

# USER root
# RUN ln -f -s /usr/bin/python3.6 /usr/bin/python3
# RUN ln -f -s /usr/bin/python3.6 /usr/bin/python
# RUN apt-get update && apt-get install -y \
#         python3-pip \
#     && rm -rf /var/lib/apt/lists/*
# RUN curl -sSL https://bootstrap.pypa.io/pip/3.6/get-pip.py | python3 -
# USER ${USERNAME}

# RUN pip install pytorch==1.5.1 torchvision==0.6.1 cudatoolkit==10.1
# RUN 
# # Install Pytorch 1.5.1
# RUN pip3 install pytorch==1.5.1 torchvision==0.6.1 cudatoolkit==10.1
# # Install mmcv-full=1.3.1
# RUN pip install mmcv-full==1.3.1 -f https://download.openmmlab.com/mmcv/dist/cu101/torch1.5.0/index.html

# USER ${USERNAME}
# COPY mmdetection3d-0.14.0 /tmp/
# WORKDIR /tmp/mmdetection3d-0.14.0/
# RUN ls .
# RUN pip install -v -e .
# # mmdetection-2.11.0 deps
# RUN pip install cython numpy

# # Install mmsegmentation=0.13.0
# RUN pip install mmsegmentation==0.13.0

# RUN pip install timm
# RUN pip install mmpycocotools